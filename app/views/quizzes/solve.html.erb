<%= render 'shared/icons' %>

<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-xl-8 col-lg-10">
      <div class="card shadow-sm border-0">
        <!-- Nag≈Ç√≥wek quizu -->
        <div class="card-header bg-primary text-white py-4">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1 me-4">
              <h1 class="h4 mb-2 d-flex align-items-center">
                <%= icon('clipboard-check', size: 'lg', css_class: 'me-3') %>
                <%= @quiz.title %>
              </h1>
              <% if @quiz.description.present? %>
                <p class="mb-0 text-light opacity-75"><%= @quiz.description %></p>
              <% end %>
            </div>
            <div class="text-end flex-shrink-0">
              <% if @quiz.time_limit && @quiz.time_limit > 0 %>
                <div id="quiz-timer" class="fs-3 fw-bold mb-1">--:--</div>
                <small class="text-light opacity-75 d-flex align-items-center justify-content-end">
                  <%= icon('timer', size: 'sm', css_class: 'me-1') %>
                  Pozosta≈Çy czas
                </small>
              <% else %>
                <div class="fs-5 fw-bold d-flex align-items-center">
                  <%= icon('infinity', size: 'sm', css_class: 'me-2') %>
                  Bez limitu czasu
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Formularz quizu -->
        <%= form_with url: submit_classroom_quiz_path(@classroom, @quiz), 
                      local: true, 
                      class: "quiz-form",
                      data: { turbo: false } do |form| %>
          
          <div class="card-body p-4">
            <!-- Pasek postƒôpu -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted">Postƒôp rozwiƒÖzania</small>
                <small class="text-muted" id="progress-counter">0/<%= @questions.size %></small>
              </div>
              <div class="progress" style="height: 6px;">
                <div id="progress-bar" class="progress-bar bg-success" style="width: 0%"></div>
              </div>
            </div>

            <!-- Pytania -->
            <% @questions.each_with_index do |question, question_index| %>
              <div class="question-card mb-4 p-4 border rounded bg-white shadow-sm" 
                   data-question-index="<%= question_index + 1 %>">
                <!-- Nag≈Ç√≥wek pytania -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h5 class="question-number text-gray-700 mb-0 d-flex align-items-center">
                    <%= icon('question-mark-circle', size: 'sm', css_class: 'me-2 text-primary') %>
                    Pytanie <%= question_index + 1 %> z <%= @questions.size %>
                  </h5>
                  <% if question.multiple_choice? %>
                    <span class="badge bg-primary-subtle text-primary border border-primary-subtle small">
                      <%= icon('check-double', size: 'xs', css_class: 'me-1') %>
                      Wielokrotny wyb√≥r
                    </span>
                  <% else %>
                    <span class="badge bg-info-subtle text-info border border-info-subtle small">
                      <%= icon('pencil', size: 'xs', css_class: 'me-1') %>
                      Otwarte
                    </span>
                  <% end %>
                </div>

                <!-- Tre≈õƒá pytania -->
                <p class="question-text fs-5 text-gray-800 mb-4"><%= question.content %></p>

                <!-- Odpowiedzi -->
                <% if question.multiple_choice? %>
                  <div class="answers-container">
                    <% question_answers = @quiz.shuffle_questions ? question.answers.shuffle : question.answers %>
                    <% question_answers.each_with_index do |answer, answer_index| %>
                      <div class="form-check mb-3 p-3 border rounded bg-light">
                        <%= form.check_box "answers[#{question.id}]", 
                                          { 
                                            multiple: true, 
                                            class: "form-check-input answer-checkbox",
                                            id: "answer_#{answer.id}"
                                          }, 
                                          answer.id, 
                                          nil %>
                        <%= form.label "answers[#{question.id}]", 
                                      class: "form-check-label fs-6 text-gray-700 w-100",
                                      for: "answer_#{answer.id}" do %>
                          <div class="d-flex align-items-center">
                            <span class="badge bg-white text-dark border me-3" style="width: 24px; height: 24px;">
                              <%= answer_index + 1 %>
                            </span>
                            <%= answer.content %>
                          </div>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <div class="open-answer-container">
                    <%= form.text_area "answers[#{question.id}]", 
                                      class: "form-control form-control-lg open-answer",
                                      rows: 4,
                                      placeholder: "Wpisz swojƒÖ odpowied≈∫...",
                                      style: "font-size: 1rem;" %>
                    <div class="form-text text-muted mt-2">
                      <%= icon('info-circle', size: 'sm', css_class: 'me-1') %>
                      Wpisz swojƒÖ odpowied≈∫ w polu powy≈ºej
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Przycisk zako≈Ñczenia -->
            <div class="text-center mt-5 pt-4 border-top">
              <%= form.submit "Zako≈Ñcz quiz", 
                             class: "btn btn-success btn-lg px-5 d-flex align-items-center mx-auto",
                             data: { 
                               confirm: "Czy na pewno chcesz zako≈Ñczyƒá quiz? Po zako≈Ñczeniu nie bƒôdziesz m√≥g≈Ç zmieniƒá odpowiedzi.",
                               disable_with: "Zapisywanie wynik√≥w..."
                             } do %>
                <%= icon('check-circle', size: 'sm', css_class: 'me-2') %>
                Zako≈Ñcz quiz
              <% end %>
              
              <small class="text-muted d-block mt-2">
                Sprawd≈∫ wszystkie odpowiedzi przed zako≈Ñczeniem
              </small>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Informacje pomocnicze -->
      <div class="card shadow-sm border-0 mt-4">
        <div class="card-header bg-white py-3">
          <h6 class="mb-0 d-flex align-items-center">
            <%= icon('information-circle', size: 'sm', css_class: 'me-2 text-info') %>
            Porady dotyczƒÖce rozwiƒÖzywania
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <h6 class="text-gray-700 d-flex align-items-center mb-2">
                <%= icon('check-double', size: 'sm', css_class: 'me-2 text-success') %>
                Pytania wielokrotnego wyboru
              </h6>
              <p class="text-muted small mb-0">
                Mo≈ºesz zaznaczyƒá jednƒÖ lub wiƒôcej poprawnych odpowiedzi. 
                Przeczytaj uwa≈ºnie wszystkie opcje przed wyborem.
              </p>
            </div>
            <div class="col-md-6 mb-3">
              <h6 class="text-gray-700 d-flex align-items-center mb-2">
                <%= icon('pencil', size: 'sm', css_class: 'me-2 text-primary') %>
                Pytania otwarte
              </h6>
              <p class="text-muted small mb-0">
                Wpisz swojƒÖ odpowied≈∫ w polu tekstowym. 
                Odpowiadaj konkretnie i wyczerpujƒÖco na zadane pytanie.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Timer JavaScript -->
<% if @quiz.time_limit && @quiz.time_limit > 0 %>
  <script>
    // Prosty timer bez konflikt√≥w
    function initializeQuizTimer() {
      console.log('üïí Initializing quiz timer...');
      
      const timeLimit = <%= @quiz.time_limit %>; // w minutach
      const startTime = new Date().getTime();
      const endTime = startTime + (timeLimit * 60 * 1000);
      const timerElement = document.getElementById('quiz-timer');
      const progressBar = document.getElementById('progress-bar');
      const progressCounter = document.getElementById('progress-counter');
      
      if (!timerElement) {
        console.error('‚ùå Timer element not found');
        return;
      }
      
      console.log('üïí Timer configured:', {
        timeLimit,
        startTime: new Date(startTime),
        endTime: new Date(endTime)
      });

      function updateTimer() {
        const now = new Date().getTime();
        const remainingTime = endTime - now;
        
        if (remainingTime <= 0) {
          timerElement.textContent = '00:00';
          timerElement.className = 'fs-3 fw-bold mb-1 text-danger';
          
          // Automatyczne zako≈Ñczenie quizu po up≈Çywie czasu
          const quizForm = document.querySelector('.quiz-form');
          if (quizForm && !quizForm.dataset.submitted) {
            quizForm.dataset.submitted = true;
            setTimeout(() => {
              if (confirm('Czas na quiz up≈ÇynƒÖ≈Ç. Quiz zostanie automatycznie zako≈Ñczony.')) {
                quizForm.submit();
              }
            }, 1000);
          }
          return;
        }
        
        const minutes = Math.floor(remainingTime / (1000 * 60));
        const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
        
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        timerElement.textContent = timeString;
        
        // Zmiana koloru przy ma≈Çej ilo≈õci czasu
        if (minutes < 5) {
          timerElement.className = 'fs-3 fw-bold mb-1 text-warning';
        }
        if (minutes < 1) {
          timerElement.className = 'fs-3 fw-bold mb-1 text-danger';
        }
        
        console.log('üïí Timer updated:', timeString);
      }
      
      function updateProgress() {
        if (!progressBar || !progressCounter) return;
        
        const answeredCheckboxes = document.querySelectorAll('.answer-checkbox:checked').length;
        const answeredTextareas = Array.from(document.querySelectorAll('.open-answer'))
          .filter(textarea => textarea.value.trim().length > 0).length;
        const answeredQuestions = answeredCheckboxes + answeredTextareas;
        const totalQuestions = <%= @questions.size %>;
        const progress = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
        
        progressBar.style.width = `${progress}%`;
        progressCounter.textContent = `${answeredQuestions}/${totalQuestions}`;
        
        // Zmiana koloru paska postƒôpu
        progressBar.className = 'progress-bar';
        if (progress >= 75) {
          progressBar.classList.add('bg-success');
        } else if (progress >= 50) {
          progressBar.classList.add('bg-warning');
        } else if (progress >= 25) {
          progressBar.classList.add('bg-primary');
        } else {
          progressBar.classList.add('bg-info');
        }
      }
      
      // Obs≈Çuga zmiany odpowiedzi
      document.querySelectorAll('.answer-checkbox, .open-answer').forEach(element => {
        element.addEventListener('change', updateProgress);
        element.addEventListener('input', updateProgress);
      });
      
      // Inicjalizacja timer
      updateTimer();
      const timerInterval = setInterval(updateTimer, 1000);
      
      // Inicjalizacja postƒôpu
      updateProgress();
      
      // Ostrze≈ºenie przed opuszczeniem strony
      let formSubmitted = false;
      
      window.addEventListener('beforeunload', function(e) {
        if (!formSubmitted) {
          e.preventDefault();
          e.returnValue = 'Czy na pewno chcesz opu≈õciƒá stronƒô? Niezapisane odpowiedzi zostanƒÖ utracone.';
          return e.returnValue;
        }
      });
      
      // Oznacz formularz jako wys≈Çany po klikniƒôciu submit
      document.querySelector('.quiz-form')?.addEventListener('submit', function() {
        formSubmitted = true;
        clearInterval(timerInterval);
      });
      
      console.log('‚úÖ Quiz timer initialized successfully');
    }

    // Inicjalizacja po za≈Çadowaniu DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeQuizTimer);
    } else {
      initializeQuizTimer();
    }
  </script>
<% else %>
  <script>
    // Aktualizacja postƒôpu dla quiz√≥w bez limitu czasu
    function initializeProgressTracker() {
      console.log('üìä Initializing progress tracker...');
      
      const progressBar = document.getElementById('progress-bar');
      const progressCounter = document.getElementById('progress-counter');
      
      if (!progressBar || !progressCounter) {
        console.error('‚ùå Progress elements not found');
        return;
      }

      function updateProgress() {
        const answeredCheckboxes = document.querySelectorAll('.answer-checkbox:checked').length;
        const answeredTextareas = Array.from(document.querySelectorAll('.open-answer'))
          .filter(textarea => textarea.value.trim().length > 0).length;
        const answeredQuestions = answeredCheckboxes + answeredTextareas;
        const totalQuestions = <%= @questions.size %>;
        const progress = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
        
        progressBar.style.width = `${progress}%`;
        progressCounter.textContent = `${answeredQuestions}/${totalQuestions}`;
        
        // Zmiana koloru paska postƒôpu
        progressBar.className = 'progress-bar';
        if (progress >= 75) {
          progressBar.classList.add('bg-success');
        } else if (progress >= 50) {
          progressBar.classList.add('bg-warning');
        } else if (progress >= 25) {
          progressBar.classList.add('bg-primary');
        } else {
          progressBar.classList.add('bg-info');
        }
        
        console.log('üìä Progress updated:', `${answeredQuestions}/${totalQuestions} (${progress.toFixed(1)}%)`);
      }
      
      document.querySelectorAll('.answer-checkbox, .open-answer').forEach(element => {
        element.addEventListener('change', updateProgress);
        element.addEventListener('input', updateProgress);
      });
      
      updateProgress();
      console.log('‚úÖ Progress tracker initialized successfully');
    }

    // Inicjalizacja
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeProgressTracker);
    } else {
      initializeProgressTracker();
    }
  </script>
<% end %>