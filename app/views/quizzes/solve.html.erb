<%# app/views/quizzes/solve.html.erb %>
<div class="container mt-4">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-0"><%= @quiz.title %></h4>
          <p class="mb-0 small"><%= @quiz.description %></p>
        </div>
        <div class="text-end">
          <% if @quiz.time_limit && @quiz.time_limit > 0 %>
            <div id="quiz-timer" class="fs-5 fw-bold"></div>
            <small>Pozostay czas</small>
          <% else %>
            <div class="fs-5 fw-bold">Brak limitu czasu</div>
          <% end %>
        </div>
      </div>
    </div>

    <%= form_with url: submit_classroom_quiz_path(@classroom, @quiz), 
                  local: true, 
                  class: "quiz-form",
                  data: { turbo: false } do |form| %>
      
      <div class="card-body">
        <% @questions.each_with_index do |question, question_index| %>
          <div class="question-card mb-4 p-3 border rounded">
            <h5 class="question-number">
              Pytanie <%= question_index + 1 %> z <%= @questions.size %>
            </h5>
            <p class="question-text fs-6 mb-3"><%= question.content %></p>

            <% if question.multiple_choice? %>
              <div class="answers-container">
                <%# U呕YJ @quiz.shuffle_questions zamiast question.shuffle_questions %>
                <% question_answers = @quiz.shuffle_questions ? question.answers.shuffle : question.answers %>
                <% question_answers.each do |answer| %>
                  <div class="form-check mb-2">
                    <%= form.check_box "answers[#{question.id}]", 
                                      { 
                                        multiple: true, 
                                        class: "form-check-input answer-checkbox",
                                        id: "answer_#{answer.id}"
                                      }, 
                                      answer.id, 
                                      nil %>
                    <%= form.label "answers[#{question.id}]", 
                                  answer.content, 
                                  value: answer.id,
                                  class: "form-check-label",
                                  for: "answer_#{answer.id}" %>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="open-answer-container">
                <%= form.text_area "answers[#{question.id}]", 
                                  class: "form-control open-answer",
                                  rows: 3,
                                  placeholder: "Wpisz swoj odpowied藕..." %>
              </div>
            <% end %>
          </div>
        <% end %>

        <div class="text-center mt-4">
          <%= form.submit "Zakocz quiz", 
                         class: "btn btn-success btn-lg",
                         data: { 
                           confirm: "Czy na pewno chcesz zakoczy quiz? Po zakoczeniu nie bdziesz m贸g zmieni odpowiedzi.",
                           disable_with: "Zapisywanie..."
                         } %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<% if @quiz.time_limit && @quiz.time_limit > 0 %>
  <script>
    // Wersja kompatybilna z Turbo
    function initializeAIGeneration() {
      const generateForm = document.getElementById('generate-form');
      const progressModalElement = document.getElementById('progressModal');
      
      if (!generateForm || !progressModalElement) {
        console.log(' AI Generation elements not found, retrying...');
        setTimeout(initializeAIGeneration, 100);
        return;
      }

      const progressModal = new bootstrap.Modal(progressModalElement);
      const progressText = document.getElementById('progress-text');
      const progressBar = document.getElementById('progress-bar');
      const progressDetail = document.getElementById('progress-detail');

      console.log(' AI Generation initialized');

      // Usu istniejce event listenery i dodaj nowe
      generateForm.removeEventListener('submit', handleFormSubmit);
      generateForm.addEventListener('submit', handleFormSubmit);

      function handleFormSubmit(e) {
        console.log(' Form submitted - showing modal');
        
        // Poka偶 modal z postpem
        progressModal.show();
        
        // Rozpocznij ledzenie postpu
        startProgressTracking();
      }

      function startProgressTracking() {
        console.log(' Starting progress tracking');
        let checkCount = 0;
        const maxChecks = 120; // maksymalnie 120 sekund (2 minuty)
        
        const checkProgress = () => {
          checkCount++;
          if (checkCount > maxChecks) {
            console.log(' Progress tracking timeout');
            progressText.textContent = 'Timeout - spr贸buj ponownie';
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-warning');
            return;
          }

          const statusUrl = '<%= generating_status_classroom_quiz_ai_questions_path(@classroom, @quiz) %>';
          console.log(' Checking progress at:', statusUrl);
          
          fetch(statusUrl)
            .then(response => {
              console.log(' Response status:', response.status);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              console.log(' Progress data received:', data);
              
              if (data.status === 'completed' || data.status === 'not_started') {
                console.log(' Generation completed or not started, stopping checks');
                // Jeli generowanie zakoczone, ukryj modal
                if (data.status === 'completed') {
                  setTimeout(() => {
                    progressModal.hide();
                  }, 500);
                }
                return;
              }

              // Aktualizuj UI
              const percent = data.total > 0 ? Math.round((data.current / data.total) * 100) : 0;
              console.log(' Updating UI - percent:', percent, 'current:', data.current, 'total:', data.total);
              
              progressBar.style.width = `${percent}%`;
              progressText.textContent = `Wygenerowano ${data.current} z ${data.total} pyta`;
              progressDetail.textContent = `${percent}% ukoczono`;

              // Kontynuuj sprawdzanie co sekund
              setTimeout(checkProgress, 1000);
            })
            .catch(error => {
              console.error(' Error checking progress:', error);
              progressText.textContent = 'Bd ledzenia postpu';
              progressDetail.textContent = 'Sprawdzanie ponownie...';
              // Pr贸ba ponownia po bdzie
              setTimeout(checkProgress, 2000);
            });
        };

        // Rozpocznij ledzenie po kr贸tkim op贸藕nieniu
        setTimeout(checkProgress, 500);
      }

      // Ukrywanie pominitych pyta
      document.querySelectorAll('.skip-btn').forEach(button => {
        button.addEventListener('click', function() {
          const questionId = this.getAttribute('data-question-id');
          const questionElement = document.getElementById(questionId);
          if (questionElement) {
            questionElement.style.display = 'none';
          }
        });
      });
    }

    // Inicjalizacja dla r贸偶nych scenariuszy Turbo
    document.addEventListener('turbo:load', initializeAIGeneration);
    document.addEventListener('turbo:render', initializeAIGeneration);

    // Bezporednie uruchomienie z op贸藕nieniem
    setTimeout(initializeAIGeneration, 200);

    // Debug info
    console.log(' Current classroom ID:', <%= @classroom.id %>);
    console.log(' Current quiz ID:', <%= @quiz.id %>);
    console.log(' Generating status URL:', '<%= generating_status_classroom_quiz_ai_questions_path(@classroom, @quiz) %>');
  </script>
<% end %>