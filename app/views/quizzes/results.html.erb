<%= render 'shared/icons' %>

<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-4 border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="flex-shrink-0">
                <%= icon('chart-bar', size: 'xl', css_class: 'text-primary') %>
              </div>
              <div class="flex-grow-1 ms-3">
                <h1 class="h4 mb-1 text-gray-800">Wyniki quizu</h1>
                <p class="text-muted mb-0"><%= @quiz.title %></p>
              </div>
            </div>
            <%= link_to classroom_quiz_path(@classroom, @quiz), 
                  class: "btn btn-outline-secondary btn-sm d-flex align-items-center" do %>
              <%= icon('arrow-left', size: 'sm', css_class: 'me-2') %>
              Powrót do quizu
            <% end %>
          </div>
        </div>
        
        <div class="card-body p-4">
          <!-- Wynik obecnego użytkownika -->
          <% user_result = @quiz.quiz_results.active.find_by(user: current_user) %>
          <% if user_result %>
            <div class="alert alert-info d-flex align-items-center">
              <%= icon('trophy', size: 'lg', css_class: 'me-3 flex-shrink-0 text-info') %>
              <div class="flex-grow-1">
                <h5 class="alert-heading mb-2">Twój wynik</h5>
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-3">
                    <strong class="fs-5"><%= user_result.score %> / <%= user_result.total %> punktów</strong>
                    <% if user_result.open_answers.ungraded.any? %>
                      <span class="badge bg-warning-subtle text-warning border border-warning-subtle">
                        <%= icon('clock', size: 'xs', css_class: 'me-1') %>
                        <%= user_result.open_answers.ungraded.count %> do oceny
                      </span>
                    <% end %>
                    <span class="badge bg-<%= result_percentage_color(user_result.score, user_result.total) %>-subtle text-<%= result_percentage_color(user_result.score, user_result.total) %> border border-<%= result_percentage_color(user_result.score, user_result.total) %>-subtle fs-6">
                      <%= number_to_percentage((user_result.score.to_f / user_result.total) * 100, precision: 1) %>
                    </span>
                    <span class="badge bg-<%= result_status_badge(user_result.status) %>-subtle text-<%= result_status_badge(user_result.status) %> border border-<%= result_status_badge(user_result.status) %>-subtle">
                      <%= result_status_text(user_result.status) %>
                    </span>
                  </div>
                  <small class="text-muted d-flex align-items-center">
                    <%= icon('clock', size: 'sm', css_class: 'me-1') %>
                    <%= user_result.created_at.strftime("%d.%m.%Y %H:%M") %>
                  </small>
                </div>

                <% if current_user.student? && user_result.open_answers.any? %>
                  <div class="mt-3 pt-3 border-top">
                    <h6 class="mb-2">Twoje odpowiedzi otwarte:</h6>
                    <% user_result.open_answers.each do |open_answer| %>
                      <div class="card mb-2">
                        <div class="card-body">
                          <p class="mb-1">
                            <strong>Pytanie:</strong> <%= open_answer.question.content %>
                          </p>
                          <p class="mb-1">
                            <strong>Twoja odpowiedź:</strong> <%= open_answer.content %>
                          </p>
                          <% if open_answer.graded? %>
                            <div class="alert alert-success py-2 mb-0">
                              <strong>Wynik:</strong> <%= open_answer.score %>/<%= open_answer.max_score %> pkt
                              <% if open_answer.teacher_feedback.present? %>
                                <br>
                                <strong>Komentarz nauczyciela:</strong> <%= open_answer.teacher_feedback %>
                              <% end %>
                            </div>
                          <% else %>
                            <div class="alert alert-warning py-2 mb-0">
                              <%= icon('clock', size: 'sm', css_class: 'me-1') %>
                              Oczekuje na ocenę przez nauczyciela
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Tabela wyników -->
          <% if @quiz_results.any? %>
            <div class="border-top pt-4 mt-4">
              <h5 class="text-gray-700 mb-3 d-flex align-items-center">
                <%= icon('users', size: 'sm', css_class: 'me-2 text-success') %>
                <% if current_user.teacher? || current_user.admin? %>
                  Wszystkie wyniki (<%= @quiz_results.count %>)
                <% else %>
                  Ranking klasy
                <% end %>
              </h5>

              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th class="text-gray-600">#</th>
                      <th class="text-gray-600">Użytkownik</th>
                      <th class="text-gray-600">Wynik</th>
                      <th class="text-gray-600">Procent</th>
                      <th class="text-gray-600">Status</th>
                      <th class="text-gray-600">Data</th>
                      <% if current_user.teacher? || current_user.admin? %>
                        <th class="text-gray-600 text-center">Akcje</th>
                      <% end %>
                    </tr>
                  </thead>
                  <tbody>
                    <% @quiz_results.each_with_index do |result, index| %>
                      <tr class="<%= 'table-active' if result.user == current_user %> align-middle">
                        <td class="fw-medium text-gray-700"><%= index + 1 %></td>
                        <td>
                          <div class="d-flex align-items-center">
                            <%= icon('user-circle', size: 'sm', css_class: 'me-2 text-gray-400') %>
                            <span class="<%= 'fw-bold text-primary' if result.user == current_user %>">
                              <%= result.user.full_name %>
                            </span>
                            <% if result.user == current_user %>
                              <span class="badge bg-primary-subtle text-primary border border-primary-subtle ms-2">
                                <%= icon('star', size: 'xs', css_class: 'me-1') %>
                                Ty
                              </span>
                            <% end %>
                          </div>
                        </td>
                        <td class="fw-bold text-gray-800"><%= result.score %> / <%= result.total %></td>
                        <td>
                          <span class="badge bg-<%= result_percentage_color(result.score, result.total) %>-subtle text-<%= result_percentage_color(result.score, result.total) %> border border-<%= result_percentage_color(result.score, result.total) %>-subtle">
                            <%= number_to_percentage((result.score.to_f / result.total) * 100, precision: 1) %>
                          </span>
                        </td>
                        <td>
                          <span class="badge bg-<%= result_status_badge(result.status) %>-subtle text-<%= result_status_badge(result.status) %> border border-<%= result_status_badge(result.status) %>-subtle">
                            <%= result_status_text(result.status) %>
                          </span>
                        </td>
                        <td class="text-gray-600">
                          <small><%= result.created_at.strftime("%d.%m.%Y %H:%M") %></small>
                        </td>
                        <% if current_user.teacher? || current_user.admin? %>
                          <td class="text-center">
                            <div class="btn-group btn-group-sm">
                              <%= link_to details_quiz_result_path(result), 
                                    class: "btn btn-outline-primary btn-sm d-flex align-items-center",
                                    title: "Szczegóły rozwiązania" do %>
                                <%= icon('eye', size: 'xs', css_class: 'me-1') %>
                                Szczegóły
                              <% end %>
                              
                              <% if policy(result).deactivate? && result.active? %>
                                <%= button_to deactivate_quiz_result_path(result),
                                      method: :patch,
                                      data: { turbo_confirm: "Dezaktywować to rozwiązanie?" },
                                      class: "btn btn-outline-warning btn-sm d-flex align-items-center",
                                      title: "Deaktywuj rozwiązanie" do %>
                                  <%= icon('eye-off', size: 'xs', css_class: 'me-1') %>
                                  Deaktywuj
                                <% end %>
                              <% end %>
                              
                              <% if policy(result).allow_retake? %>
                                <%= button_to allow_retake_quiz_result_path(result),
                                      method: :patch,
                                      data: { turbo_confirm: "Zezwolić na ponowne podejście? Stare rozwiązanie zostanie oznaczone jako zastąpione." },
                                      class: "btn btn-outline-success btn-sm d-flex align-items-center",
                                      title: "Zezwól na ponowne podejście" do %>
                                  <%= icon('refresh', size: 'xs', css_class: 'me-1') %>
                                  Ponowne podejście
                                <% end %>
                              <% end %>
                            </div>
                          </td>
                        <% end %>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Statystyki dla nauczyciela/admina -->
            <% if current_user.teacher? || current_user.admin? %>
              <div class="border-top pt-4 mt-4">
                <h5 class="text-gray-700 mb-3 d-flex align-items-center">
                  <%= icon('chart-pie', size: 'sm', css_class: 'me-2 text-info') %>
                  Statystyki quizu
                </h5>
                
                <div class="row g-3">
                  <!-- Podstawowe statystyki -->
                  <div class="col-md-3">
                    <div class="card border-0 bg-primary bg-opacity-10">
                      <div class="card-body text-center">
                        <%= icon('users', size: 'xl', css_class: 'text-primary mb-2') %>
                        <h4 class="text-primary mb-1"><%= @quiz_results.active.count %></h4>
                        <p class="text-muted mb-0 small">Aktywnych rozwiązań</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card border-0 bg-success bg-opacity-10">
                      <div class="card-body text-center">
                        <%= icon('trophy', size: 'xl', css_class: 'text-success mb-2') %>
                        <h4 class="text-success mb-1"><%= @best_score %>%</h4>
                        <p class="text-muted mb-0 small">Najlepszy wynik</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card border-0 bg-warning bg-opacity-10">
                      <div class="card-body text-center">
                        <%= icon('chart-bar', size: 'xl', css_class: 'text-warning mb-2') %>
                        <h4 class="text-warning mb-1"><%= @average_score %>%</h4>
                        <p class="text-muted mb-0 small">Średni wynik</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card border-0 bg-danger bg-opacity-10">
                      <div class="card-body text-center">
                        <%= icon('exclamation', size: 'xl', css_class: 'text-danger mb-2') %>
                        <h4 class="text-danger mb-1"><%= @worst_score %>%</h4>
                        <p class="text-muted mb-0 small">Najsłabszy wynik</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Statystyki statusów -->
                <div class="row g-3 mt-2">
                  <div class="col-md-4">
                    <div class="card border-0 bg-info bg-opacity-10">
                      <div class="card-body text-center">
                        <%= icon('check-circle', size: 'xl', css_class: 'text-info mb-2') %>
                        <h4 class="text-info mb-1"><%= @quiz_results.active.count %></h4>
                        <p class="text-muted mb-0 small">Aktywne</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card border-0 bg-secondary bg-opacity-10">
                      <div class="card-body text-center">
                        <%= icon('x-circle', size: 'xl', css_class: 'text-secondary mb-2') %>
                        <h4 class="text-secondary mb-1"><%= @quiz_results.inactive.count %></h4>
                        <p class="text-muted mb-0 small">Dezaktywowane</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card border-0 bg-warning bg-opacity-10">
                      <div class="card-body text-center">
                        <%= icon('pencil', size: 'xl', css_class: 'text-warning mb-2') %>
                        <h4 class="text-warning mb-1"><%= @quiz_results.retaken.count %></h4>
                        <p class="text-muted mb-0 small">Zastąpione</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>

          <% else %>
            <div class="text-center py-5">
              <%= icon('inbox', size: 'xl', css_class: 'text-gray-300 mb-3') %>
              <h5 class="text-gray-500">Brak wyników</h5>
              <p class="text-muted">Nikt jeszcze nie rozwiązał tego quizu.</p>
            </div>
          <% end %>

          <% if current_user.teacher? || current_user.admin? %>
            <% ungraded_answers = OpenAnswer.joins(:quiz_result, :question)
                                            .where(quiz_results: { 
                                            quiz_id: @quiz.id,
                                            status: :active
                                            })
                                            .ungraded %>
            
            <% if ungraded_answers.any? %>
              <div class="border-top pt-4 mt-4">
                <h5 class="text-gray-700 mb-3 d-flex align-items-center">
                  <%= icon('pencil', size: 'sm', css_class: 'me-2 text-warning') %>
                  Odpowiedzi otwarte do oceny (<%= ungraded_answers.count %>)
                </h5>
                
                <div class="accordion" id="openAnswersAccordion">
                  <% ungraded_answers.each_with_index do |open_answer, index| %>
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button <%= index > 0 ? 'collapsed' : '' %>" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapse<%= open_answer.id %>"
                                aria-expanded="<%= index == 0 ? 'true' : 'false' %>"
                                aria-controls="collapse<%= open_answer.id %>">
                          <div class="d-flex w-100 justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                              <%= icon('user-circle', size: 'sm', css_class: 'me-2 text-gray-400') %>
                              <span class="me-3"><%= open_answer.user.full_name %></span>
                              <span class="badge bg-warning-subtle text-warning small">
                                Pytanie <%= open_answer.question.content.truncate(30) %>
                              </span>
                            </div>
                            <small class="text-muted">
                              <%= time_ago_in_words(open_answer.created_at) %> temu
                            </small>
                          </div>
                        </button>
                      </h2>
                      <div id="collapse<%= open_answer.id %>" 
                          class="accordion-collapse collapse <%= index == 0 ? 'show' : '' %>" 
                          data-bs-parent="#openAnswersAccordion">
                        <div class="accordion-body">
                          <!-- Treść pytania -->
                          <div class="mb-3">
                            <strong class="text-gray-600">Pytanie:</strong>
                            <p class="mb-0"><%= open_answer.question.content %></p>
                          </div>
                          
                          <!-- Odpowiedź ucznia -->
                          <div class="mb-3">
                            <strong class="text-gray-600">Odpowiedź ucznia:</strong>
                            <div class="card bg-light border-0 mt-2">
                              <div class="card-body">
                                <p class="mb-0"><%= simple_format(open_answer.content) %></p>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Formularz oceny -->
                          <%= form_with url: grade_open_answer_path(open_answer), 
                                        method: :patch,
                                        class: "grade-open-answer-form" do |form| %>
                            <div class="row g-3">
                              <div class="col-md-3">
                                <label class="form-label">Wynik (0-<%= open_answer.max_score %> pkt)</label>
                                <%= form.number_field "open_answer[score]", 
                                      class: "form-control",
                                      min: 0,
                                      max: open_answer.max_score,
                                      value: open_answer.score || 0,
                                      required: true %>
                              </div>
                              <div class="col-md-6">
                                <label class="form-label">Komentarz (opcjonalnie)</label>
                                <%= form.text_area "open_answer[feedback]", 
                                      class: "form-control",
                                      rows: 2,
                                      placeholder: "Dodaj konstruktywną informację zwrotną...",
                                      value: open_answer.teacher_feedback %>
                              </div>
                              <div class="col-md-3 d-flex align-items-end">
                                <%= form.submit "Zapisz ocenę", 
                                      class: "btn btn-primary w-100 d-flex align-items-center justify-content-center" do %>
                                  <%= icon('check', size: 'sm', css_class: 'me-2') %>
                                  Oceń
                                <% end %>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <!-- Już ocenione odpowiedzi (do podglądu) -->
            <% graded_answers = OpenAnswer.joins(:quiz_result, :question)
                                          .where(quiz_results: { 
                                            quiz_id: @quiz.id,
                                            status: :active
                                            })
                                          .graded
                                          .order(updated_at: :desc)
                                          .limit(10) %>
            
            <% if graded_answers.any? %>
              <div class="border-top pt-4 mt-4">
                <h5 class="text-gray-700 mb-3 d-flex align-items-center">
                  <%= icon('check-circle', size: 'sm', css_class: 'me-2 text-success') %>
                  Ostatnio ocenione odpowiedzi
                </h5>
                
                <div class="row g-3">
                  <% graded_answers.each do |open_answer| %>
                    <div class="col-md-6">
                      <div class="card border">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <strong><%= open_answer.user.full_name %></strong>
                            <span class="badge bg-success-subtle text-success">
                              <%= open_answer.score %>/<%= open_answer.max_score %> pkt
                            </span>
                          </div>
                          <p class="small text-muted mb-2">
                            <strong>Pytanie:</strong> <%= open_answer.question.content.truncate(50) %>
                          </p>
                          <p class="small mb-2">
                            <strong>Odpowiedź:</strong> <%= open_answer.content.truncate(70) %>
                          </p>
                          <% if open_answer.teacher_feedback.present? %>
                            <div class="border-top pt-2 mt-2">
                              <small class="text-gray-600">Komentarz nauczyciela:</small>
                              <p class="small mb-0"><%= open_answer.teacher_feedback.truncate(50) %></p>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>

          <!-- Akcje dodatkowe -->
          <div class="border-top pt-4 mt-4">
            <div class="d-flex justify-content-between align-items-center">
              <%= link_to classroom_path(@classroom), 
                    class: "btn btn-outline-secondary d-flex align-items-center" do %>
                <%= icon('arrow-left', size: 'sm', css_class: 'me-2') %>
                Powrót do klasy
              <% end %>
              
              <% if policy(@quiz).solve? && @quiz.status == :ongoing && !user_result %>
                <%= button_to start_classroom_quiz_path(@classroom, @quiz),
                      method: :post,
                      class: "btn btn-success d-flex align-items-center" do %>
                  <%= icon('play', size: 'sm', css_class: 'me-2') %>
                  Rozpocznij quiz
                <% end %>
              <% elsif policy(@quiz).solve? && @quiz.status == :ongoing && user_result&.inactive? %>
                <div class="alert alert-warning d-flex align-items-center">
                  <%= icon('information-circle', size: 'lg', css_class: 'me-3 text-warning') %>
                  <div class="flex-grow-1">
                    <p class="mb-2">Twoje poprzednie rozwiązanie zostało dezaktywowane przez nauczyciela.</p>
                    <%= link_to "Rozpocznij quiz ponownie", start_classroom_quiz_path(@classroom, @quiz), 
                          class: "btn btn-primary btn-sm d-flex align-items-center",
                          data: { turbo: false } %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>