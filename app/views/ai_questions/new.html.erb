<%# app/views/ai_questions/new.html.erb %>
<div class="container mt-5">
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">‚ú® Generuj pytania AI dla: <%= @quiz.title %></h4>
        </div>
        <div class="card-body">
          <%= form_with url: classroom_quiz_ai_questions_path(@classroom, @quiz), 
                      method: :post, 
                      local: true,
                      data: { turbo: false },
                      id: 'generate-form' do |form| %>
          
          <div class="mb-3">
            <%= form.label :prompt, "Opisz tematykƒô pyta≈Ñ", class: "form-label" %>
            <%= form.text_area :prompt, 
                            class: "form-control", 
                            rows: 4,
                            placeholder: "np.: 'Podstawy programowania w Ruby - pƒôtle, warunki, metody. Poziom poczƒÖtkujƒÖcy.'",
                            required: true,
                            value: params[:prompt] || "" %>
          </div>

          <div class="mb-3">
            <%= form.label :count, "Liczba pyta≈Ñ do wygenerowania", class: "form-label" %>
            <%= form.select :count, [1, 2, 3, 5], { selected: params[:count] || 3 }, class: "form-select" %>
          </div>

          <div class="d-flex gap-2">
            <%= form.submit "Generuj pytania", 
                          class: "btn btn-primary", 
                          data: { disable_with: "Generowanie..." },
                          onclick: "showProgressModal(event)" %>
            <%= link_to "Anuluj", classroom_quiz_path(@classroom, @quiz), class: "btn btn-secondary" %>
          </div>
          <% end %>

          <!-- PROSTY MODAL (bez Bootstrap) -->
          <div id="progressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
            <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center;">
              <h5>üîÑ Generowanie pyta≈Ñ AI</h5>
              <div style="width: 3rem; height: 3rem; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 1rem auto;"></div>
              <p id="progress-text" style="margin: 1rem 0; font-size: 1.1rem;">Przygotowywanie...</p>
              <div style="height: 20px; background: #e9ecef; border-radius: 4px; margin: 1rem 0; overflow: hidden;">
                <div id="progress-bar" style="height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); width: 0%; transition: width 0.5s ease-in-out;"></div>
              </div>
              <small class="text-muted" id="progress-detail" style="display: block; margin-top: 0.5rem;">To mo≈ºe zajƒÖƒá do 30 sekund</small>
              <div id="progress-time" style="font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem;"></div>
            </div>
          </div>
        </div>
      </div>

      <%# ‚úÖ KOMUNIKATY %>
      <% if flash[:success] %>
        <div class="alert alert-success mt-4 alert-dismissible fade show" role="alert">
          <%= flash[:success] %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% elsif flash[:error] %>
        <div class="alert alert-danger mt-4 alert-dismissible fade show" role="alert">
          <%= flash[:error] %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>

      <%# ‚úÖ LISTA WYGENEROWANYCH PYTA≈É %>
      <% if @ai_questions.is_a?(Array) && @ai_questions.any? %>
        <div class="card mt-4">
          <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üéØ Wygenerowane pytania (<%= @ai_questions.size %>)</h5>
            <div>
              <%= button_to "‚úÖ Dodaj wszystkie", 
                          add_all_to_quiz_classroom_quiz_ai_questions_path(@classroom, @quiz),
                          method: :post,
                          class: "btn btn-light btn-sm me-2",
                          form: { data: { turbo_confirm: "Na pewno dodaƒá wszystkie #{@ai_questions.size} pyta≈Ñ do quizu?" } } %>
              
                <%= button_to "üóëÔ∏è Wyczy≈õƒá", 
                            clear_questions_classroom_quiz_ai_questions_path(@classroom, @quiz),
                            method: :delete,
                            class: "btn btn-outline-light btn-sm",
                            form: { 
                                data: { 
                                turbo_confirm: "Na pewno wyczy≈õciƒá wszystkie wygenerowane pytania?",
                                turbo_action: "replace" 
                                } 
                            } %>
            </div>
          </div>
          <div class="card-body">
            <% @ai_questions.each_with_index do |question_data, index| %>
              <% answers = question_data[:answers_attributes] || question_data["answers_attributes"] %>
              
              <% if question_data.is_a?(Hash) && answers.is_a?(Array) && answers.any? %>
                <div class="generated-question mb-4 p-3 border rounded" id="question-<%= index %>">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="mb-0">Pytanie <%= index + 1 %>:</h6>
                    <span class="badge bg-primary">Wielokrotny wyb√≥r</span>
                  </div>
                  
                  <% content = question_data[:content] || question_data["content"] %>
                  <p class="fw-bold fs-5 mb-3"><%= content || "Brak tre≈õci pytania" %></p>
                  
                  <div class="answers">
                    <% answers.each_with_index do |answer, answer_index| %>
                      <% answer_content = answer[:content] || answer["content"] %>
                      <% answer_correct = answer[:correct] || answer["correct"] %>
                      
                      <% if answer_content %>
                        <div class="form-check mb-2">
                          <input class="form-check-input" type="radio" disabled <%= 'checked' if answer_correct %>>
                          <label class="form-check-label <%= 'text-success fw-bold' if answer_correct %>">
                            <%= answer_content %>
                            <% if answer_correct %> 
                              <span class="badge bg-success ms-1">Poprawna</span>
                            <% end %>
                          </label>
                        </div>
                      <% end %>
                    <% end %>
                  </div>

                  <div class="mt-3 pt-3 border-top">
                    <%= button_to "‚úÖ Dodaj to pytanie", 
                                add_to_quiz_classroom_quiz_ai_questions_path(@classroom, @quiz),
                                method: :post,
                                params: { 
                                  question_data: question_data.to_json,
                                  question_index: index
                                },
                                class: "btn btn-success btn-sm me-2",
                                form: { data: { turbo_confirm: "Na pewno dodaƒá to pytanie do quizu?" } } %>
                    
                    <button type="button" class="btn btn-outline-danger btn-sm skip-btn" 
                           data-question-id="question-<%= index %>">
                      ‚ùå Pomi≈Ñ
                    </button>
                  </div>
                </div>
              <% else %>
                <div class="alert alert-warning mb-3">
                  <strong>Pytanie <%= index + 1 %>:</strong> Niepoprawna struktura danych
                  <div class="mt-2">
                    <small class="text-muted">
                      <strong>Debug info:</strong><br>
                      question_data type: <%= question_data.class %><br>
                      answers type: <%= answers.class %><br>
                      answers count: <%= answers.is_a?(Array) ? answers.size : 'N/A' %>
                    </small>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% elsif flash[:notice] %>
        <div class="alert alert-info mt-4">
          <%= flash[:notice] %>
          <div class="mt-2">
            <%= link_to "Generuj wiƒôcej pyta≈Ñ", new_classroom_quiz_ai_questions_path(@classroom, @quiz), class: "btn btn-primary btn-sm me-2" %>
            <%= link_to "Przejd≈∫ do quizu", classroom_quiz_path(@classroom, @quiz), class: "btn btn-success btn-sm" %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">üí° Przyk≈Çady prompt√≥w</h5>
        </div>
        <div class="card-body">
          <ul class="list-unstyled small">
            <li class="mb-2">
              <strong>Ruby on Rails:</strong><br>
              <span class="text-muted">"Podstawy MVC, migracje bazy danych, relacje ActiveRecord"</span>
            </li>
            <li class="mb-2">
              <strong>Matematyka:</strong><br>
              <span class="text-muted">"R√≥wnania kwadratowe, funkcje liniowe, pierwiastki"</span>
            </li>
            <li class="mb-2">
              <strong>Historia:</strong><br>
              <span class="text-muted">"II Wojna ≈öwiatowa - najwa≈ºniejsze bitwy, postanowienia"</span>
            </li>
            <li class="mb-2">
              <strong>Biologia:</strong><br>
              <span class="text-muted">"Fotosynteza - etapy, rola chlorofilu, czynniki"</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- DEBUG INFO -->
      <div class="card mt-3">
        <div class="card-header">
          <h6 class="mb-0">üêõ Debug Info</h6>
        </div>
        <div class="card-body">
          <p><strong>User ID:</strong> <%= current_user.id %></p>
          <p><strong>Quiz ID:</strong> <%= @quiz.id %></p>
          <p><strong>Generation Key:</strong> ai_generation_user_<%= current_user.id %>_quiz_<%= @quiz.id %></p>
          <p><strong>Questions in cache:</strong> <%= @ai_questions.size if @ai_questions.is_a?(Array) %></p>
          <p><small class="text-muted">Klucz cache jest u≈ºywany do ≈õledzenia postƒôpu miƒôdzy requestami</small></p>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
// Sprawd≈∫ czy style ju≈º istnieje przed dodaniem
if (!document.getElementById('ai-progress-styles')) {
  const style = document.createElement('style');
  style.id = 'ai-progress-styles';
  style.textContent = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
}

// Inicjalizacja po za≈Çadowaniu strony
function initializeAIPage() {
  console.log('üîç Initializing AI questions page...');
  
  // Ukrywanie pominiƒôtych pyta≈Ñ
  document.querySelectorAll('.skip-btn').forEach(button => {
    button.addEventListener('click', function() {
      const questionId = this.getAttribute('data-question-id');
      const questionElement = document.getElementById(questionId);
      if (questionElement) {
        questionElement.style.display = 'none';
        console.log('üîç Question hidden:', questionId);
      }
    });
  });
  
  console.log('üîç AI page initialized successfully');
}

// G≈Ç√≥wna funkcja do pokazywania modala
function showProgressModal(event) {
  console.log('üîç showProgressModal called!');
  
  const modal = document.getElementById('progressModal');
  if (modal) {
    modal.style.display = 'flex';
    console.log('üîç Modal shown!');
    
    // Zresetuj pasek postƒôpu
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressDetail = document.getElementById('progress-detail');
    const progressTime = document.getElementById('progress-time');
    
    if (progressBar) progressBar.style.width = '0%';
    if (progressText) progressText.textContent = 'Rozpoczynanie generowania...';
    if (progressDetail) progressDetail.textContent = '≈ÅƒÖczenie z AI...';
    if (progressTime) progressTime.textContent = 'Czas: 0s';
  } else {
    console.log('‚ùå Modal not found!');
  }
  
  // Rozpocznij ≈õledzenie postƒôpu
  startProgressTracking();
}

// ≈öledzenie postƒôpu
function startProgressTracking() {
  console.log('üîç Starting progress tracking...');
  
  const statusUrl = '<%= generating_status_classroom_quiz_ai_questions_path(@classroom, @quiz) %>';
  const progressText = document.getElementById('progress-text');
  const progressBar = document.getElementById('progress-bar');
  const progressDetail = document.getElementById('progress-detail');
  const progressTime = document.getElementById('progress-time');
  const modal = document.getElementById('progressModal');
  
  let checkCount = 0;
  const maxChecks = 180;
  const startTime = Date.now();
  
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  
  function checkProgress() {
    checkCount++;
    const currentTime = Math.floor((Date.now() - startTime) / 1000);
    
    console.log('üîç Progress check #' + checkCount + ' at ' + currentTime + 's');
    
    const urlWithTimestamp = statusUrl + '?t=' + Date.now();
    
    fetch(urlWithTimestamp)
      .then(response => {
        console.log('üîç Response status:', response.status);
        if (!response.ok) throw new Error('HTTP error: ' + response.status);
        return response.json();
      })
      .then(data => {
        console.log('üîç Progress data received:', data);
        
        if (progressBar && progressText && progressDetail) {
          const percent = data.total > 0 ? Math.round((data.current / data.total) * 100) : 0;
          progressBar.style.width = percent + '%';
          progressText.textContent = `Wygenerowano ${data.current} z ${data.total} pyta≈Ñ`;
          progressDetail.textContent = `${percent}% uko≈Ñczono`;
          
          if (progressTime) {
            progressTime.textContent = `Czas: ${formatTime(currentTime)}`;
          }
        }
        
        if (data.status === 'completed') {
          console.log('üîç Generation completed!');
          if (progressText) progressText.textContent = '‚úÖ Generowanie zako≈Ñczone!';
          if (progressDetail) progressDetail.textContent = 'Przekierowywanie...';
          if (progressBar) progressBar.style.width = '100%';
          
          if (modal) {
            setTimeout(() => {
              modal.style.display = 'none';
              // Prze≈Çaduj stronƒô ≈ºeby zobaczyƒá nowe pytania
              window.location.reload();
            }, 1500);
          }
          return;
        }
        
        if (checkCount >= maxChecks) {
          console.log('üîç Timeout reached');
          if (modal) modal.style.display = 'none';
          return;
        }
        
        setTimeout(checkProgress, 1000);
      })
      .catch(error => {
        console.error('üîç Fetch error:', error);
        setTimeout(checkProgress, 2000);
      });
  }
  
  setTimeout(checkProgress, 500);
}

// Event listeners
document.addEventListener('DOMContentLoaded', initializeAIPage);
document.addEventListener('turbo:load', initializeAIPage);
document.addEventListener('turbo:render', initializeAIPage);

// Bezpo≈õrednia inicjalizacja
setTimeout(initializeAIPage, 100);
</script>