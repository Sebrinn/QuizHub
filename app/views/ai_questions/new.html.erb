<%# app/views/ai_questions/new.html.erb %>
<div class="container mt-5">
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">‚ú® Generuj pytania AI dla: <%= @quiz.title %></h4>
        </div>
        <div class="card-body">
          <%= form_with url: classroom_quiz_ai_questions_path(@classroom, @quiz), 
                      method: :post, 
                      local: true,
                      data: { turbo: false },
                      id: 'generate-form' do |form| %>
          
          <div class="mb-3">
            <%= form.label :prompt, "Opisz tematykƒô pyta≈Ñ", class: "form-label" %>
            <%= form.text_area :prompt, 
                            class: "form-control", 
                            rows: 4,
                            placeholder: "np.: 'Podstawy programowania w Ruby - pƒôtle, warunki, metody. Poziom poczƒÖtkujƒÖcy.'",
                            required: true,
                            value: "" %>
          </div>

          <div class="mb-3">
            <%= form.label :count, "Liczba pyta≈Ñ do wygenerowania", class: "form-label" %>
            <%= form.select :count, [1, 2, 3, 5], { selected: params[:count] || 3 }, class: "form-select" %>
          </div>

          <div class="d-flex gap-2">
            <%= form.submit "Generuj pytania", class: "btn btn-primary", data: { disable_with: "Generowanie..." } %>
            <%= link_to "Anuluj", classroom_quiz_path(@classroom, @quiz), class: "btn btn-secondary" %>
          </div>
          <% end %>
        <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="progressModalLabel">üîÑ Generowanie pyta≈Ñ</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">≈Åadowanie...</span>
                    </div>
                    <p id="progress-text">Przygotowywanie...</p>
                    <div class="progress mb-3">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                        role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="progress-detail">To mo≈ºe zajƒÖƒá do 30 sekund</small>
                </div>
                </div>
            </div>
        </div>
        </div>
      </div>

      <%# ‚úÖ KOMUNIKATY %>
      <% if flash[:success] %>
        <div class="alert alert-success mt-4 alert-dismissible fade show" role="alert">
          <%= flash[:success] %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% elsif flash[:error] %>
        <div class="alert alert-danger mt-4 alert-dismissible fade show" role="alert">
          <%= flash[:error] %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>

      <%# ‚úÖ LISTA WYGENEROWANYCH PYTA≈É %>
      <% if @ai_questions.is_a?(Array) && @ai_questions.any? %>
        <div class="card mt-4">
          <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üéØ Wygenerowane pytania (<%= @ai_questions.size %>)</h5>
            <div>
              <%= button_to "‚úÖ Dodaj wszystkie", 
                          add_all_to_quiz_classroom_quiz_ai_questions_path(@classroom, @quiz),
                          method: :post,
                          class: "btn btn-light btn-sm me-2",
                          data: { turbo_confirm: "Na pewno dodaƒá wszystkie #{@ai_questions.size} pyta≈Ñ do quizu?" } %>
              
              <%= button_to "üóëÔ∏è Wyczy≈õƒá", 
                          clear_questions_classroom_quiz_ai_questions_path(@classroom, @quiz),
                          method: :delete,
                          class: "btn btn-outline-light btn-sm" %>
            </div>
          </div>
          <div class="card-body">
            <% @ai_questions.each_with_index do |question_data, index| %>
              <%# ‚úÖ POPRAWIONE: Sprawd≈∫ obie mo≈ºliwe struktury (symbol i string) %>
              <% answers = question_data[:answers_attributes] || question_data["answers_attributes"] %>
              
              <% if question_data.is_a?(Hash) && answers.is_a?(Array) && answers.any? %>
                <div class="generated-question mb-4 p-3 border rounded" id="question-<%= index %>">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="mb-0">Pytanie <%= index + 1 %>:</h6>
                    <span class="badge bg-primary">Wielokrotny wyb√≥r</span>
                  </div>
                  
                  <% content = question_data[:content] || question_data["content"] %>
                  <p class="fw-bold fs-5 mb-3"><%= content || "Brak tre≈õci pytania" %></p>
                  
                  <div class="answers">
                    <% answers.each do |answer| %>
                      <% answer_content = answer[:content] || answer["content"] %>
                      <% answer_correct = answer[:correct] || answer["correct"] %>
                      
                      <% if answer_content %>
                        <div class="form-check mb-2">
                          <input class="form-check-input" type="radio" disabled <%= 'checked' if answer_correct %>>
                          <label class="form-check-label <%= 'text-success fw-bold' if answer_correct %>">
                            <%= answer_content %>
                            <% if answer_correct %> 
                              <span class="badge bg-success ms-1">Poprawna</span>
                            <% end %>
                          </label>
                        </div>
                      <% end %>
                    <% end %>
                  </div>

                  <div class="mt-3 pt-3 border-top">
                    <%= button_to "‚úÖ Dodaj to pytanie", 
                                add_to_quiz_classroom_quiz_ai_questions_path(@classroom, @quiz),
                                method: :post,
                                params: { 
                                  question_data: question_data.to_json,
                                  question_index: index
                                },
                                class: "btn btn-success btn-sm me-2",
                                data: { turbo_confirm: "Na pewno dodaƒá to pytanie do quizu?" } %>
                    
                    <button type="button" class="btn btn-outline-secondary btn-sm skip-btn" 
                           data-question-id="question-<%= index %>">
                      ‚ùå Pomi≈Ñ
                    </button>
                  </div>
                </div>
              <% else %>
                <div class="alert alert-warning mb-3">
                  <strong>Pytanie <%= index + 1 %>:</strong> Niepoprawna struktura danych
                  <div class="mt-2">
                    <small class="text-muted">
                      <strong>Debug info:</strong><br>
                      question_data: <%= question_data.present? %><br>
                      answers_attributes: <%= answers.class %><br>
                      answers count: <%= answers.is_a?(Array) ? answers.size : 'N/A' %>
                    </small>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% elsif flash[:notice] %>
        <div class="alert alert-info mt-4">
          <%= flash[:notice] %>
          <div class="mt-2">
            <%= link_to "Generuj wiƒôcej pyta≈Ñ", new_classroom_quiz_ai_questions_path(@classroom, @quiz), class: "btn btn-primary btn-sm me-2" %>
            <%= link_to "Przejd≈∫ do quizu", classroom_quiz_path(@classroom, @quiz), class: "btn btn-success btn-sm" %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">üí° Przyk≈Çady prompt√≥w</h5>
        </div>
        <div class="card-body">
          <ul class="list-unstyled small">
            <li class="mb-2">
              <strong>Ruby on Rails:</strong><br>
              <span class="text-muted">"Podstawy MVC, migracje bazy danych, relacje ActiveRecord"</span>
            </li>
            <li class="mb-2">
              <strong>Matematyka:</strong><br>
              <span class="text-muted">"R√≥wnania kwadratowe, funkcje liniowe, pierwiastki"</span>
            </li>
            <li class="mb-2">
              <strong>Historia:</strong><br>
              <span class="text-muted">"II Wojna ≈öwiatowa - najwa≈ºniejsze bitwy, postanowienia"</span>
            </li>
            <li class="mb-2">
              <strong>Biologia:</strong><br>
              <span class="text-muted">"Fotosynteza - etapy, rola chlorofilu, czynniki"</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const generateForm = document.getElementById('generate-form');
  const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
  const progressText = document.getElementById('progress-text');
  const progressBar = document.getElementById('progress-bar');
  const progressDetail = document.getElementById('progress-detail');

  if (generateForm) {
    generateForm.addEventListener('submit', function() {
      // Poka≈º modal z postƒôpem
      progressModal.show();
      
      // Rozpocznij ≈õledzenie postƒôpu
      startProgressTracking();
    });
  }

  function startProgressTracking() {
    const checkProgress = () => {
      fetch('<%= generating_status_classroom_quiz_ai_questions_path(@classroom, @quiz) %>')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'completed' || data.status === 'not_started') {
            // Generowanie zako≈Ñczone - ukryj modal przy nastƒôpnym prze≈Çadowaniu
            return;
          }

          // Aktualizuj UI
          const percent = data.total > 0 ? Math.round((data.current / data.total) * 100) : 0;
          progressBar.style.width = `${percent}%`;
          progressText.textContent = `Wygenerowano ${data.current} z ${data.total} pyta≈Ñ`;
          progressDetail.textContent = `${percent}% uko≈Ñczono`;

          // Kontynuuj sprawdzanie co sekundƒô
          setTimeout(checkProgress, 1000);
        })
        .catch(error => {
          console.error('Error checking progress:', error);
          // Pr√≥ba ponownia po b≈Çƒôdzie
          setTimeout(checkProgress, 2000);
        });
    };

    // Rozpocznij ≈õledzenie po kr√≥tkim op√≥≈∫nieniu (daj czas na inicjalizacjƒô)
    setTimeout(checkProgress, 500);
  }

  // Ukrywanie pominiƒôtych pyta≈Ñ (istniejƒÖcy kod)
  document.querySelectorAll('.skip-btn').forEach(button => {
    button.addEventListener('click', function() {
      const questionId = this.getAttribute('data-question-id');
      const questionElement = document.getElementById(questionId);
      if (questionElement) {
        questionElement.style.display = 'none';
      }
    });
  });
});
</script>

<style>
.progress-bar-animated {
  animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
  0% { background-position-x: 1rem; }
}
</style>