<%= render 'shared/icons' %>

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-4 border-bottom">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <%= icon('robot', size: 'xl', css_class: 'text-primary') %>
            </div>
            <div class="flex-grow-1 ms-3">
              <h1 class="h4 mb-1 text-gray-800">Generuj pytania AI</h1>
              <p class="text-muted mb-0">Dla: <%= @quiz.title %></p>
            </div>
          </div>
        </div>
        
        <div class="card-body p-4">
          <%= form_with url: classroom_quiz_ai_questions_path(@classroom, @quiz), 
                      method: :post, 
                      local: true,
                      data: { turbo: false },
                      id: 'generate-form',
                      class: 'needs-validation' do |form| %>
          
          <div class="mb-4">
            <%= form.label :prompt, class: "form-label fw-medium text-gray-700" do %>
              <%= icon_with_text('edit', 'Opisz tematykƒô pyta≈Ñ', size: 'sm') %>
            <% end %>
            <%= form.text_area :prompt, 
                            class: "form-control form-control-lg", 
                            rows: 4,
                            placeholder: "np.: 'Podstawy programowania w Ruby - pƒôtle, warunki, metody. Poziom poczƒÖtkujƒÖcy.'",
                            required: true,
                            value: params[:prompt] || "" %>
            <div class="form-text text-muted">
              Opisz szczeg√≥≈Çowo tematykƒô, poziom trudno≈õci i kontekst pyta≈Ñ
            </div>
          </div>

          <div class="mb-4">
            <%= form.label :count, class: "form-label fw-medium text-gray-700" do %>
              <%= icon_with_text('hash', 'Liczba pyta≈Ñ do wygenerowania', size: 'sm') %>
            <% end %>
            <%= form.select :count, [1, 2, 3, 5], { selected: params[:count] || 3 }, class: "form-select form-select-lg" %>
          </div>

          <div class="mb-4">
            <%= form.label :question_type, class: "form-label fw-medium text-gray-700" do %>
              <%= icon_with_text('collection', 'Typ pyta≈Ñ', size: 'sm') %>
            <% end %>
            <%= form.select :question_type, 
                          [
                            ['Mieszane (zamkniƒôte i otwarte)', 'mixed'],
                            ['Tylko wielokrotny wyb√≥r', 'multiple_choice'],
                            ['Tylko pytania otwarte', 'open_ended']
                          ], 
                          { selected: params[:question_type] || 'mixed' }, 
                          class: "form-select form-select-lg" %>
            <div class="form-text text-muted">
              Wybierz typ generowanych pyta≈Ñ
            </div>
          </div>

          <div class="d-flex gap-3 mt-4 pt-3 border-top">
            <%= form.submit "Generuj pytania", 
                          class: "btn btn-primary btn-lg flex-fill d-flex align-items-center justify-content-center", 
                          data: { disable_with: "Generowanie..." },
                          onclick: "showProgressModal(event)" %>
            <%= link_to classroom_quiz_path(@classroom, @quiz), class: "btn btn-outline-secondary flex-fill d-flex align-items-center justify-content-center" do %>
              <%= icon('arrow-left', size: 'sm', css_class: 'me-2') %>
              Anuluj
            <% end %>
          </div>
          <% end %>
        </div>
      </div>

      <!-- Modal postƒôpu -->
      <div id="progressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div class="bg-white rounded-3 shadow-lg p-4" style="max-width: 400px; width: 90%;">
          <div class="text-center">
            <h5 class="text-gray-800 mb-3">
              <%= icon('robot', size: 'lg', css_class: 'me-2 text-primary') %>
              Generowanie pyta≈Ñ AI
            </h5>
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
            <p id="progress-text" class="text-gray-700 mb-2">Przygotowywanie...</p>
            <div class="progress mb-2" style="height: 8px;">
              <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
            </div>
            <small class="text-muted d-block" id="progress-detail">To mo≈ºe zajƒÖƒá do 30 sekund</small>
            <div id="progress-time" class="text-muted small mt-2"></div>
          </div>
        </div>
      </div>

      <!-- Komunikaty -->
      <% if flash[:success] %>
        <div class="alert alert-success mt-4 alert-dismissible fade show d-flex align-items-center" role="alert">
          <%= icon('check-circle', size: 'lg', css_class: 'me-2 flex-shrink-0') %>
          <div class="flex-grow-1"><%= flash[:success] %></div>
          <button type="button" class="btn-close flex-shrink-0" data-bs-dismiss="alert"></button>
        </div>
      <% elsif flash[:error] %>
        <div class="alert alert-danger mt-4 alert-dismissible fade show d-flex align-items-center" role="alert">
          <%= icon('exclamation-triangle', size: 'lg', css_class: 'me-2 flex-shrink-0') %>
          <div class="flex-grow-1"><%= flash[:error] %></div>
          <button type="button" class="btn-close flex-shrink-0" data-bs-dismiss="alert"></button>
        </div>
      <% end %>

      <!-- Lista wygenerowanych pyta≈Ñ -->
      <% if @ai_questions.is_a?(Array) && @ai_questions.any? %>
        <div class="card shadow-sm border-0 mt-4">
          <div class="card-header bg-success text-white py-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 d-flex align-items-center">
                <%= icon('check-circle', size: 'sm', css_class: 'me-2') %>
                Wygenerowane pytania (<%= @ai_questions.size %>)
              </h5>
              <div class="d-flex gap-2">
                <%= button_to add_all_to_quiz_classroom_quiz_ai_questions_path(@classroom, @quiz),
                          method: :post,
                          class: "btn btn-light btn-sm d-flex align-items-center",
                          form: { data: { turbo_confirm: "Na pewno dodaƒá wszystkie #{@ai_questions.size} pyta≈Ñ do quizu?" } } do %>
                  <%= icon('plus', size: 'sm', css_class: 'me-1') %>
                  Dodaj wszystkie
                <% end %>
                
                <%= button_to clear_questions_classroom_quiz_ai_questions_path(@classroom, @quiz),
                          method: :delete,
                          class: "btn btn-outline-light btn-sm d-flex align-items-center",
                          form: { data: { turbo_confirm: "Na pewno wyczy≈õciƒá wszystkie wygenerowane pytania?" } } do %>
                  <%= icon('trash', size: 'sm', css_class: 'me-1') %>
                  Wyczy≈õƒá
                <% end %>
              </div>
            </div>
          </div>
          <div class="card-body">
            <% @ai_questions.each_with_index do |question_data, index| %>
              <% question_type = question_data[:question_type] || question_data["question_type"] %>
              <% max_score = question_data[:max_score] || question_data["max_score"] %>
              
              <div class="generated-question mb-4 p-3 border rounded" id="question-<%= index %>">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h6 class="mb-0 d-flex align-items-center">
                    <%= icon('question-circle', size: 'sm', css_class: 'me-2 text-gray-500') %>
                    Pytanie <%= index + 1 %>
                  </h6>
                  <span class="badge <%= question_type == 'open_ended' ? 'bg-info-subtle text-info' : 'bg-primary-subtle text-primary' %> border <%= question_type == 'open_ended' ? 'border-info-subtle' : 'border-primary-subtle' %>">
                    <%= icon(question_type == 'open_ended' ? 'pencil' : 'check-double', size: 'sm', css_class: 'me-1') %>
                    <%= question_type == 'open_ended' ? 'Otwarte' : 'Wielokrotny wyb√≥r' %>
                    <% if question_type == 'open_ended' && max_score %>
                      <span class="ms-1">(max: <%= max_score %> pkt)</span>
                    <% end %>
                  </span>
                </div>
                
                <% content = question_data[:content] || question_data["content"] %>
                <p class="fw-bold text-gray-800 mb-3"><%= content || "Brak tre≈õci pytania" %></p>
                
                <% if question_type == 'multiple_choice' %>
                  <% answers = question_data[:answers_attributes] || question_data["answers_attributes"] || [] %>
                  <div class="answers">
                    <% answers.each_with_index do |answer, answer_index| %>
                      <% answer_content = answer[:content] || answer["content"] %>
                      <% answer_correct = answer[:correct] || answer["correct"] %>
                      
                      <% if answer_content %>
                        <div class="form-check mb-2">
                          <input class="form-check-input" type="radio" disabled <%= 'checked' if answer_correct %>>
                          <label class="form-check-label <%= 'text-success fw-bold' if answer_correct %>">
                            <%= answer_content %>
                            <% if answer_correct %> 
                              <span class="badge bg-success-subtle text-success border border-success-subtle ms-1">
                                <%= icon('check', size: 'xs', css_class: 'me-1') %>
                                Poprawna
                              </span>
                            <% end %>
                          </label>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                <% else %>
                  <!-- Dla pyta≈Ñ otwartych -->
                  <div class="alert alert-info d-flex align-items-start">
                    <%= icon('info-circle', size: 'lg', css_class: 'me-3 mt-1 flex-shrink-0 text-info') %>
                    <div class="flex-grow-1">
                      <small>
                        <strong>Pytanie otwarte</strong><br>
                        Ucze≈Ñ bƒôdzie musia≈Ç samodzielnie sformu≈Çowaƒá odpowied≈∫ tekstowƒÖ.<br>
                        <span class="text-muted">
                          Maksymalna punktacja: <%= max_score || 5 %> punkt√≥w
                        </span>
                      </small>
                    </div>
                  </div>
                <% end %>

                <div class="mt-3 pt-3 border-top d-flex gap-2">
                  <%= button_to add_to_quiz_classroom_quiz_ai_questions_path(@classroom, @quiz),
                            method: :post,
                            params: { 
                              question_data: question_data.to_json,
                              question_index: index
                            },
                            class: "btn btn-success btn-sm d-flex align-items-center",
                            form: { data: { turbo_confirm: "Na pewno dodaƒá to pytanie do quizu?" } } do %>
                    <%= icon('plus', size: 'sm', css_class: 'me-1') %>
                    Dodaj to pytanie
                  <% end %>
                  
                  <button type="button" class="btn btn-outline-danger btn-sm d-flex align-items-center skip-btn" 
                        data-question-id="question-<%= index %>">
                    <%= icon('x', size: 'sm', css_class: 'me-1') %>
                    Pomi≈Ñ
                  </button>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% elsif flash[:notice] %>
        <div class="alert alert-info mt-4 d-flex align-items-center">
          <%= icon('info-circle', size: 'lg', css_class: 'me-3 flex-shrink-0 text-info') %>
          <div class="flex-grow-1">
            <%= flash[:notice] %>
            <div class="mt-2 d-flex gap-2">
              <%= link_to new_classroom_quiz_ai_questions_path(@classroom, @quiz), class: "btn btn-primary btn-sm d-flex align-items-center" do %>
                <%= icon('robot', size: 'sm', css_class: 'me-1') %>
                Generuj wiƒôcej pyta≈Ñ
              <% end %>
              <%= link_to classroom_quiz_path(@classroom, @quiz), class: "btn btn-success btn-sm d-flex align-items-center" do %>
                <%= icon('arrow-right', size: 'sm', css_class: 'me-1') %>
                Przejd≈∫ do quizu
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0 d-flex align-items-center">
            <%= icon('lightbulb', size: 'sm', css_class: 'me-2 text-warning') %>
            Przyk≈Çady prompt√≥w
          </h5>
        </div>
        <div class="card-body">
          <div class="list-group list-group-flush">
            <div class="list-group-item px-0 border-0">
              <strong class="d-block text-gray-700">Ruby on Rails</strong>
              <small class="text-muted">"Podstawy MVC, migracje bazy danych, relacje ActiveRecord"</small>
            </div>
            <div class="list-group-item px-0 border-0">
              <strong class="d-block text-gray-700">Matematyka</strong>
              <small class="text-muted">"R√≥wnania kwadratowe, funkcje liniowe, pierwiastki"</small>
            </div>
            <div class="list-group-item px-0 border-0">
              <strong class="d-block text-gray-700">Historia</strong>
              <small class="text-muted">"II Wojna ≈öwiatowa - najwa≈ºniejsze bitwy, postanowienia"</small>
            </div>
            <div class="list-group-item px-0 border-0">
              <strong class="d-block text-gray-700">Biologia</strong>
              <small class="text-muted">"Fotosynteza - etapy, rola chlorofilu, czynniki"</small>
            </div>
            <div class="list-group-item px-0 border-0">
              <strong class="d-block text-gray-700">Dla pyta≈Ñ otwartych</strong>
              <small class="text-muted">"Por√≥wnaj X i Y, wyja≈õnij proces Z, opisz wp≈Çyw A na B..."</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Debug Info -->
      <div class="card shadow-sm border-0 mt-3">
        <div class="card-header bg-white py-3">
          <h6 class="mb-0 d-flex align-items-center">
            <%= icon('bug', size: 'sm', css_class: 'me-2 text-secondary') %>
            Informacje debug
          </h6>
        </div>
        <div class="card-body">
          <dl class="row small mb-0">
            <dt class="col-sm-5 text-gray-600">User ID:</dt>
            <dd class="col-sm-7"><%= current_user.id %></dd>
            
            <dt class="col-sm-5 text-gray-600">Quiz ID:</dt>
            <dd class="col-sm-7"><%= @quiz.id %></dd>
            
            <dt class="col-sm-5 text-gray-600">Generation Key:</dt>
            <dd class="col-sm-7"><code>ai_generation_user_<%= current_user.id %>_quiz_<%= @quiz.id %></code></dd>
            
            <dt class="col-sm-5 text-gray-600">Questions in cache:</dt>
            <dd class="col-sm-7"><%= @ai_questions.size if @ai_questions.is_a?(Array) %></dd>

            <dt class="col-sm-5 text-gray-600">Question types:</dt>
            <dd class="col-sm-7">
              <% if @ai_questions.is_a?(Array) %>
                <% types = @ai_questions.map { |q| q[:question_type] || q["question_type"] } %>
                <%= types.tally.to_json %>
              <% end %>
            </dd>
          </dl>
          <small class="text-muted mt-2 d-block">Klucz cache jest u≈ºywany do ≈õledzenia postƒôpu miƒôdzy requestami</small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Sprawd≈∫ czy style ju≈º istnieje przed dodaniem
if (!document.getElementById('ai-progress-styles')) {
  const style = document.createElement('style');
  style.id = 'ai-progress-styles';
  style.textContent = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
}

// Inicjalizacja po za≈Çadowaniu strony
function initializeAIPage() {
  console.log('üîç Initializing AI questions page...');
  
  // Ukrywanie pominiƒôtych pyta≈Ñ
  document.querySelectorAll('.skip-btn').forEach(button => {
    button.addEventListener('click', function() {
      const questionId = this.getAttribute('data-question-id');
      const questionElement = document.getElementById(questionId);
      if (questionElement) {
        questionElement.style.display = 'none';
        console.log('üîç Question hidden:', questionId);
      }
    });
  });
  
  console.log('üîç AI page initialized successfully');
}

// G≈Ç√≥wna funkcja do pokazywania modala
function showProgressModal(event) {
  console.log('üîç showProgressModal called!');
  
  const modal = document.getElementById('progressModal');
  if (modal) {
    modal.style.display = 'flex';
    console.log('üîç Modal shown!');
    
    // Zresetuj pasek postƒôpu
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressDetail = document.getElementById('progress-detail');
    const progressTime = document.getElementById('progress-time');
    
    if (progressBar) progressBar.style.width = '0%';
    if (progressText) progressText.textContent = 'Rozpoczynanie generowania...';
    if (progressDetail) progressDetail.textContent = '≈ÅƒÖczenie z AI...';
    if (progressTime) progressTime.textContent = 'Czas: 0s';
  } else {
    console.log('‚ùå Modal not found!');
  }
  
  // Rozpocznij ≈õledzenie postƒôpu
  startProgressTracking();
}

// ≈öledzenie postƒôpu
function startProgressTracking() {
  console.log('üîç Starting progress tracking...');
  
  const statusUrl = '<%= generating_status_classroom_quiz_ai_questions_path(@classroom, @quiz) %>';
  const progressText = document.getElementById('progress-text');
  const progressBar = document.getElementById('progress-bar');
  const progressDetail = document.getElementById('progress-detail');
  const progressTime = document.getElementById('progress-time');
  const modal = document.getElementById('progressModal');
  
  let checkCount = 0;
  const maxChecks = 180;
  const startTime = Date.now();
  
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  
  function checkProgress() {
    checkCount++;
    const currentTime = Math.floor((Date.now() - startTime) / 1000);
    
    console.log('üîç Progress check #' + checkCount + ' at ' + currentTime + 's');
    
    const urlWithTimestamp = statusUrl + '?t=' + Date.now();
    
    fetch(urlWithTimestamp)
      .then(response => {
        console.log('üîç Response status:', response.status);
        if (!response.ok) throw new Error('HTTP error: ' + response.status);
        return response.json();
      })
      .then(data => {
        console.log('üîç Progress data received:', data);
        
        if (progressBar && progressText && progressDetail) {
          const percent = data.total > 0 ? Math.round((data.current / data.total) * 100) : 0;
          progressBar.style.width = percent + '%';
          progressText.textContent = `Wygenerowano ${data.current} z ${data.total} pyta≈Ñ`;
          progressDetail.textContent = `${percent}% uko≈Ñczono`;
          
          if (progressTime) {
            progressTime.textContent = `Czas: ${formatTime(currentTime)}`;
          }
        }
        
        if (data.status === 'completed') {
          console.log('üîç Generation completed!');
          if (progressText) progressText.textContent = '‚úÖ Generowanie zako≈Ñczone!';
          if (progressDetail) progressDetail.textContent = 'Przekierowywanie...';
          if (progressBar) progressBar.style.width = '100%';
          
          if (modal) {
            setTimeout(() => {
              modal.style.display = 'none';
              // Prze≈Çaduj stronƒô ≈ºeby zobaczyƒá nowe pytania
              window.location.reload();
            }, 1500);
          }
          return;
        }
        
        if (checkCount >= maxChecks) {
          console.log('üîç Timeout reached');
          if (modal) modal.style.display = 'none';
          return;
        }
        
        setTimeout(checkProgress, 1000);
      })
      .catch(error => {
        console.error('üîç Fetch error:', error);
        setTimeout(checkProgress, 2000);
      });
  }
  
  setTimeout(checkProgress, 500);
}

// Event listeners
document.addEventListener('DOMContentLoaded', initializeAIPage);
document.addEventListener('turbo:load', initializeAIPage);
document.addEventListener('turbo:render', initializeAIPage);

// Bezpo≈õrednia inicjalizacja
setTimeout(initializeAIPage, 100);
</script>